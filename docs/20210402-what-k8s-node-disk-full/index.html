<!doctype html>
<html lang="en-us">

<head>
  <title>å•¥? k8s node ç¡¬ç¢Ÿç©ºé–“æ»¿äº† | XiaoXiao Notes</title>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.62.2" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Xiao Xiao" />
  <meta name="description"
    content="" />
  <link rel="stylesheet" href="https://blog.10oz.tw/css/main.min.5ade29aff989990df1b116e145537ab55c8452957abda497ceebd8704d182b4c.css" />
  <link rel="shortcut icon" href="https://blog.10oz.tw/favicon.ico">

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å•¥? k8s node ç¡¬ç¢Ÿç©ºé–“æ»¿äº†"/>
<meta name="twitter:description" content="ç™¼ç¾ k8s æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº† æ»¿äº†è€¶ï¼ï¼æ€éº¼æœƒé€™æ¨£ è¶é‚„æœ‰ç©ºé–“è¶•å¿« ssh é€²å»çœ‹ä¸€çœ¼
dev@k8s07:~$ df -h Filesystem Size Used Avail Use% Mounted on udev 5.9G 0 5.9G 0% /dev tmpfs 1.2G 4.5M 1.2G 1% /run /dev/mapper/ubuntu--vg-ubuntu--lv 98G 70G 23G 76% / tmpfs 5.9G 0 5.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 5.9G 0 5.9G 0% /sys/fs/cgroup /dev/sda2 976M 213M 696M 24% /boot tmpfs 1.2G 0 1.2G 0% /run/user/1000 é–‰çœ¼å…ˆæ¸…ç©ºä¸€æ³¢ Docker image, volumn&hellip;
docker system prune -a æª¢æŸ¥ä¸€ä¸‹é‚„æœ‰å•¥ç±³æ±è¥¿ä½”ç”¨äº†æˆ‘å€‘çš„ç©ºé–“"/>

  <meta property="og:title" content="å•¥? k8s node ç¡¬ç¢Ÿç©ºé–“æ»¿äº†" />
<meta property="og:description" content="ç™¼ç¾ k8s æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº† æ»¿äº†è€¶ï¼ï¼æ€éº¼æœƒé€™æ¨£ è¶é‚„æœ‰ç©ºé–“è¶•å¿« ssh é€²å»çœ‹ä¸€çœ¼
dev@k8s07:~$ df -h Filesystem Size Used Avail Use% Mounted on udev 5.9G 0 5.9G 0% /dev tmpfs 1.2G 4.5M 1.2G 1% /run /dev/mapper/ubuntu--vg-ubuntu--lv 98G 70G 23G 76% / tmpfs 5.9G 0 5.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 5.9G 0 5.9G 0% /sys/fs/cgroup /dev/sda2 976M 213M 696M 24% /boot tmpfs 1.2G 0 1.2G 0% /run/user/1000 é–‰çœ¼å…ˆæ¸…ç©ºä¸€æ³¢ Docker image, volumn&hellip;
docker system prune -a æª¢æŸ¥ä¸€ä¸‹é‚„æœ‰å•¥ç±³æ±è¥¿ä½”ç”¨äº†æˆ‘å€‘çš„ç©ºé–“" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.10oz.tw/20210402-what-k8s-node-disk-full/" />
<meta property="article:published_time" content="2021-04-02T01:19:30+08:00" />
<meta property="article:modified_time" content="2021-04-02T01:19:30+08:00" />

</head>

<body>
    
  <header class="app-header">
    <a href="https://blog.10oz.tw">
      <img class="app-header-avatar" src="/profile.jpg"
        alt="Xiao Xiao" />
      <h1 class="title">XiaoXiao Notes</h1>
    </a>
    <p class="sub-title"> XiaoXiao çš„ç­†è¨˜æ›¸</p>

    <div class="social-icon">
      
      <a target="_blank" href="https://github.com/XiaoXiaoSN"
        rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
      
    </div>

    <aside>
      <ul class="start-menu">
        
        
        
            <li>
            <a href="/">
                <span>å›åˆ°æ–‡ç« åˆ—è¡¨</span>
            </a>
            </li>
        
        
        
            <li>
            <a href="/tags">
                <span>ç”¨ Tags åˆ†é¡</span>
            </a>
            </li>
        
        
        
            <li>
            <a href="/about">
                <span>é—œæ–¼ XiaoXiao</span>
            </a>
            </li>
        
        

      </ul>
    </aside>
  </header>


  <main class="app-container">
    

<article class="post">
  <header class="post-header">
    <h1 class="post-title">å•¥? k8s node ç¡¬ç¢Ÿç©ºé–“æ»¿äº†</h1>
    <div class="post-meta">
      <div>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
        Apr 2, 2021
      </div><div>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
        <a class="tag" href="https://blog.10oz.tw/tags/docker/">docker</a><a class="tag" href="https://blog.10oz.tw/tags/linux/">linux</a><a class="tag" href="https://blog.10oz.tw/tags/log/">log</a></div></div>
  </header>

  <aside>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ç™¼ç¾-k8s-æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº†">ç™¼ç¾ k8s æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº†</a></li>
    <li><a href="#è§£æ±ºä»–">è§£æ±ºä»–</a>
      <ul>
        <li><a href="#ä¸€å€‹å°å‘">ä¸€å€‹å°å‘</a></li>
      </ul>
    </li>
    <li><a href="#ref">Ref</a></li>
  </ul>
</nav>
  </aside>

  <div class="post-content">
    <h2 id="ç™¼ç¾-k8s-æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº†">ç™¼ç¾ k8s æ©Ÿå™¨çš„ç¡¬ç¢Ÿç©ºé–“æ»¿äº†</h2>
<p>æ»¿äº†è€¶ï¼ï¼æ€éº¼æœƒé€™æ¨£
<img src="https://i.imgur.com/09T0qb3.png" alt=""></p>
<p>è¶é‚„æœ‰ç©ºé–“è¶•å¿« ssh é€²å»çœ‹ä¸€çœ¼</p>
<pre><code>dev@k8s07:~$ df -h
Filesystem                         Size  Used Avail Use% Mounted on
udev                               5.9G     0  5.9G   0% /dev
tmpfs                              1.2G  4.5M  1.2G   1% /run
/dev/mapper/ubuntu--vg-ubuntu--lv   98G   70G   23G  76% /
tmpfs                              5.9G     0  5.9G   0% /dev/shm
tmpfs                              5.0M     0  5.0M   0% /run/lock
tmpfs                              5.9G     0  5.9G   0% /sys/fs/cgroup
/dev/sda2                          976M  213M  696M  24% /boot
tmpfs                              1.2G     0  1.2G   0% /run/user/1000
</code></pre><p>é–‰çœ¼å…ˆæ¸…ç©ºä¸€æ³¢ Docker image, volumn&hellip;</p>
<pre><code>docker system prune -a
</code></pre><p>æª¢æŸ¥ä¸€ä¸‹é‚„æœ‰å•¥ç±³æ±è¥¿ä½”ç”¨äº†æˆ‘å€‘çš„ç©ºé–“</p>
<pre><code>sudo du -ahx / | sort -rh | head -n 20
</code></pre><pre><code>find /var/lib/docker/ -name &quot;*.log&quot; -exec ls -sh {} \; | sort -h -r | head -20
</code></pre><p>ä¸€çœ‹ç™¼ç¾åŸä¾†æˆ‘æœ‰ä¸€å€‹ 30G ä¸€å€‹ 18G çš„ docker logsï¼Œæœ‰å¤ å¤§å•¦ğŸ˜‚
çœ‹ä¸€ä¸‹ log å…§å®¹å°±ç™¼ç¾äº†åŸå› æ˜¯æœ€è¿‘æ–°å¢çš„çˆ¬èŸ²çš„é—œä¿‚ QQ (é‚„æœ‰ fluent-bit ä¹Ÿä¸å°)</p>
<h2 id="è§£æ±ºä»–">è§£æ±ºä»–</h2>
<p>æ²’äº‹æ²’äº‹ï¼Œä¹‹å‰å¯èƒ½å¤§æ„äº†æ²’æœ‰æƒ³åˆ°é€™ç¨® Case ç°¡å–®åŠ å€‹è¦å‰‡å°±å¥½äº†</p>
<pre><code>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
   &quot;exec-opts&quot;: [&quot;native.cgroupdriver=cgroupfs&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;1g&quot;,
    &quot;max-file&quot;: &quot;3&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;
}
EOF
</code></pre><p>The max-size is a limit on the docker log file, so it includes the json or local log formatting overhead. And the max-file is the number of logfiles docker will maintain. After the size limit is reached on one file, the logs are rotated, and the oldest logs are deleted when you exceed max-file.</p>
<blockquote>
<p>Note: Restart Docker for the changes to take effect for newly created containers. Existing containers do not use the new logging configuration.</p>
</blockquote>
<pre><code># Restart docker.
systemctl restart docker

# æ‰‹å‹•åˆªé™¤èˆŠçš„å¤§æª”æ¡ˆ
cat /dev/null &gt; å¤§æª”æ¡ˆ.log
</code></pre><h3 id="ä¸€å€‹å°å‘">ä¸€å€‹å°å‘</h3>
<p>å¦å¤–è¦æ³¨æ„ï¼Œæˆ‘ç¬¬ä¸€æ¬¡å¯«çš„æ™‚å€™ daemon.json docker cgroup driver è¨­å®šæˆ systemd å°±ç‚¸æ‰äº†XDD</p>
<pre><code>$ journalctl -xeu kubelet
# ....something
failed to run Kubelet: misconfiguration: kubelet cgroup driver: &quot;cgroupfs&quot; is different from docker cgroup driver: &quot;systemd&quot;
# ...something
</code></pre><h2 id="ref">Ref</h2>
<p><a href="https://www.linode.com/community/questions/16922/my-disk-is-filling-up-how-can-i-find-the-culprit">https://www.linode.com/community/questions/16922/my-disk-is-filling-up-how-can-i-find-the-culprit</a>
<a href="https://docs.docker.com/config/containers/logging/configure/#configure-the-default-logging-driver">https://docs.docker.com/config/containers/logging/configure/#configure-the-default-logging-driver</a>
<a href="https://stackoverflow.com/questions/31829587/docker-container-logs-taking-all-my-disk-space">https://stackoverflow.com/questions/31829587/docker-container-logs-taking-all-my-disk-space</a></p>

  </div>

  <div class="post-footer">
    
  </div>
</article>


  </main>
</body>

</html>
